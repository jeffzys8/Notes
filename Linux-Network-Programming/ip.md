# IP协议

包含三部分内容：
- IP header; src/dst IP addr, IP分片重组信息, 部分通信行为的指定(?)
- IP数据报的路由和转发
- 简要讨论IPv6

IP协议：无状态、无连接、不可靠

无状态：相互独立的数据报，最大问题是可能乱序/重复，无需内核维护通信状态

不可靠：可能丢掉；路由器发现IP-datagram传输时间过长(header里的TTL?)，丢弃并返回ICMP超时错误；<u>但IP-datagram本身的内容是有做校验的</u>(不对，只有头部校验和)

## IPv4 header

- 4位版本号 (4, 6)
- 4位头部长度 (15*32bit = 60bytes)
- 8位服务类型(TOS), 其中4位分别表示：最小延时，最大吞吐量，最高可靠性，最小费用。最多一位置为1
- 16为表示整个IP-datagram长度(bytes)，**最大为65535bytes**（还要减去头60bytes才是具体数据)，超过MTU将分片传输
- **分片相关** 
  - 16位identification **唯一标识数据报**;
  - 3位标识是否允许分片、该数据报是否为分片; 
  - 13位offset，实际偏移值 << 3 (×8), 因此每个分片长度都得是8的整数倍
- 8位生存时间(TTL Time To Live), 实际上是允许经过的路由器跳数，通常64
- 8位区分上层协议(ICMP=1, TCP=6, UDP=17)
- 16位头部校验和，CRC算法**检验头部** (所以传输层才对数据校验)
- 32位 src-IP, 32位 dstIP
  - 书上说一般这俩经过多少个中转路由器都不会变，那NAT也不变吗?
- 最多60位的option字段

tcpdump 抓IPv4 header 2.2.2

## IP分片

可能发生在发送端，可能在路由器上，也可能多次分片；在最终目标机器上才会组装。

IP数据报的具体数据最多是 1500bytes(以太网帧MTU) - 20bytes(IP-header) = 1480bytes

具体的计算过程用到再看就行，不是很复杂。

## IP路由、转发

> 暂时略过

## IPv6

解决了地址不够用，增加了对多播和流的支持。

> 暂时略过