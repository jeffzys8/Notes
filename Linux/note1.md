# 主机规划与磁盘分割

> **[这一部分关于磁盘和开机的内容实在是太重要了，需要经常翻阅](http://linux.vbird.org/linux_basic/0130designlinux.php)** <br>当前学到2.2.4

## 设备
在Linux系统中，每个设备都被当做一个文件来对待 (在Android中的虚拟机也被当做设备 ```/dev/kvm```，在后面了解到kvm不仅仅是Android虚拟机这么简单)

[各种设备命名](http://linux.vbird.org/linux_basic/0130designlinux.php#hardware_no)

## 虚拟机
至於如果你原本就用 Linux 系統，例如 Fedora/Ubuntu 等系列的話，那麼建議你使用原本系統內就有的**虛擬機器管理員**來處理即可。目前 Linux 系統大多使用 **KVM 這個虛擬化軟體**就是了。底下提供一些網站給您學習學習！鳥哥之後的章節所使用的機器，就是透過 KVM 建置出來的系統喔！ 提供給妳作參考囉。

> 实践一下ubuntu的kvm呀

正常的實體機器大概使用的都是 ```/dev/sd[a-]``` 的磁碟檔名，至於**虛擬機器環境**底下，為了加速，可能就會使用 ```/dev/vd[a-p]``` 這種裝置檔名

## 磁盘
由於SATA/USB/SAS等磁碟介面都是使用SCSI模組來驅動的， 因此這些介面的磁碟裝置檔名都是```/dev/sd[a-p]```的格式。 所以SATA/USB介面的磁碟根本就沒有一定的順序，那如何決定他的裝置檔名呢？ 這個時候就得要**根據Linux核心偵測到磁碟的順序**了

> 对扇区、柱面这些概念不熟

整顆**磁碟的第一個磁區**特別的重要，因為他記錄了整顆磁碟的重要資訊；

两种磁盘“分割”方式 —— 早期磁碟第一個磁區裡面含有的重要資訊我們稱**為MBR (Master Boot Record)** 格式，但是由於近年來磁碟的容量不斷擴大，造成讀寫上的一些困擾， 甚至有些大於 2TB 以上的磁碟分割已經讓某些作業系統無法存取。因此後來又多了一個新的磁碟分割格式，稱為 **GPT (GUID partition table)**！ 這兩種分割格式與限制不太相同啦！

> 分割表的内容看不太懂，时时回看

分割最小单位是柱面？通过延伸分割，MBR可分割多于4个分区；但```dev/sda[1~4]```都是分配给主分区/拓展分区，逻辑分区就列到后面去了

- 主要分割與延伸分割最多可以有四筆(硬碟的限制)
- **延伸分割最多只能有一個**(作業系統的限制)
- 邏輯分割是由延伸分割持續切割出來的分割槽；
- 能夠被格式化後，作為資料存取的分割槽為主要分割與邏輯分割。延伸分割無法格式化；
- 邏輯分割的數量依作業系統而不同，在Linux系統中SATA硬碟已經可以突破63個以上的分割限制；

如果你要分割超過4槽以上時，一定要有Extended分割槽，而且**必須將所有剩下的空間都分配給Extended**， 然後再以logical的分割來規劃Extended的空間。 另外，考慮到磁碟的連續性，一般**建議將Extended的磁柱號碼分配在最後面的磁柱內**。

**GPT 分区表**<br>
與 MBR 僅使用第一個 512bytes 區塊來紀錄不同， GPT 使用了 34 個 LBA 區塊來紀錄分割資訊！同時與過去 MBR 僅有一的區塊，被幹掉就死光光的情況不同， GPT 除了前面 34 個 LBA 之外，**整個磁碟的最後 33 個 LBA 也拿來作為另一個備份**！這樣或許會比較安全些吧！

> GPT的内容需要回看呢

## 開機流程中的 BIOS 與 UEFI 開機檢測程式

基本上，目前的主機系統在載入硬體驅動方面的程序，主要有**早期的 BIOS** 與**新的 UEFI** 兩種機制，我們分別來談談囉！

**BIOS 搭配 MBR/GPT 的開機流程**
1. BIOS：開機主動執行的韌體，會認識第一個可開機的裝置；
> 在主板上；寻找可以开机的设备
2. MBR：第一個可開機裝置的第一個扇区內的主要開機記錄區塊，內含**引导加载程序**；
> 在存储设备(磁盘)上，第一个扇区
3. 引导加载程序(boot loader)：一支可讀取内核文件來執行的軟體；
> Grub就是其中一种，可用于引导多系统
4. 核心檔案：開始作業系統的功能...

由上面的說明我們會知道，BIOS與MBR都是硬體本身會支援的功能，至於**Boot loader則是作業系統安裝在MBR上面的一套軟體**了。由於MBR僅有446 bytes而已，因此這個開機管理程式是非常小而美的。 這個boot loader的主要任務有底下這些項目：

- 提供選單：使用者可以選擇不同的開機項目，這也是**多重開機**的重要功能！
- 載入核心檔案：直接指向可開機的程式區段來**開始操作系统**；
- 轉交其他loader：將開機管理功能**轉交給其他loader**負責。

> 也是要常常回看的内容呀

**每個分割槽都擁有自己的開機磁區**(boot sector), loader只會認識自己的系統槽內的可開機核心檔案，以及其他loader而已;loader可直接指向或者是間接將管理權轉交給另一個管理程式。

『**如果要安裝多重開機， 最好先安裝Windows再安裝Linux**』呢？這是因為：

- **Linux**在安裝的時候，你可以選擇將boot loader安裝在MBR或各別分割槽的開機磁區， 而且Linux的loader可以手動設定選單(就是上圖的M1, M2...)，所以**你可以在Linux的boot loader裡面加入Windows開機的選項**；

- Windows在安裝的時候，他的安裝程式**會主動的覆蓋掉MBR以及自己所在分割槽的開機磁區**，你沒有選擇的機會， 而且他沒有讓我們自己選擇選單的功能。

> 那么问题来了，装了Linux以后还想装Windows该怎么办呢，怎么防止Windows覆盖MBR? 

> 我在自己尝试的时候，将Ubuntu装在U盘上，发现开机进入Grub，是不是Ubuntu自带了Grub，然后Grub覆盖了MBR？然后我将U盘内容格式化，又能直接引导进入Windows，那Grub还在不在？

**UEFI BIOS 搭配 GPT 開機的流程**

- 與傳統的 BIOS 不同，UEFI 簡直就像是一個**低階的作業系統**
- 硬體資源的管理使用輪詢 (polling) 的方式來管理，與 BIOS 直接了解 CPU 以中斷的方式來管理比較， 這種 **polling 的效率是稍微慢一些**的

>下面这一点，我在Dell机上重装系统就遇到过；说明这台机是UEFI
- 此外，由於過去 cracker 經常藉由 BIOS 開機階段來破壞系統，並取得系統的控制權，因此 **UEFI 加入了一個所謂的安全啟動 (secure boot) 機制**， 這個機制代表著即將開機的作業系統必須要被 UEFI 所驗證，否則就無法順利開機！微軟用了很多這樣的機制來管理硬體。 不過**加入這個機制後，許多的作業系統，包括 Linux ，就很有可能無法順利開機**喔！所以，某些時刻，你可能得要**將 UEFI 的 secure boot 功能關閉**， 才能夠順利的進入 Linux 哩！ (這一點讓自由軟體工作者相當感冒啦！)