# 主机规划与磁盘分割

> **[这一部分关于磁盘和开机的内容实在是太重要了，需要经常翻阅](http://linux.vbird.org/linux_basic/0130designlinux.php)** <br>当前学到2.2.4

## 设备
在Linux系统中，每个设备都被当做一个文件来对待(在Android中的虚拟机也被当做设备```/dev/kvm```，在后面了解到kvm不仅仅是Android虚拟机这么简单)

[各种设备命名](http://linux.vbird.org/linux_basic/0130designlinux.php#hardware_no)

## 虚拟机
至于如果你原本就用 Linux 系统，例如 Fedora/Ubuntu 等系列的话，那么建议你使用原本系统内就有的**虚拟机器管理员**来处理即可。目前 Linux 系统大多使用 **KVM 这个虚拟化软体**就是了。底下提供一些网站给您学习学习！鸟哥之后的章节所使用的机器，就是透过 KVM 建置出来的系统喔！提供给妳作参考啰。

> 实践一下ubuntu的kvm呀

正常的实体机器大概使用的都是```/dev/sd[a-]``` 的磁碟档名，至于**虚拟机器环境**底下，为了加速，可能就会使用```/ dev/vd[ap]``` 这种装置档名

## 磁盘
由于SATA/USB/SAS等磁碟介面都是使用SCSI模组来驱动的， 因此这些介面的磁碟装置档名都是```/dev/sd[a-p]```的格式。所以SATA/USB介面的磁碟根本就没有一定的顺序，那如何决定他的装置档名呢？这个时候就得要**根据Linux核心侦测到磁碟的顺序**了

> 对扇区、柱面这些概念不熟

整颗**磁碟的第一个磁区**特别的重要，因为他记录了整颗磁碟的重要资讯；

两种磁盘“分割”方式—— 早期磁碟第一个磁区里面含有的重要资讯我们称**为MBR (Master Boot Record)** 格式，但是由于近年来磁碟的容量不断扩大，造成读写上的一些困扰， 甚至有些大于2TB 以上的磁碟分割已经让某些作业系统无法存取。因此后来又多了一个新的磁碟分割格式，称为 **GPT (GUID partition table)**！这两种分割格式与限制不太相同啦！

> 分割表的内容看不太懂，时时回看

分割最小单位是柱面？通过延伸分割，MBR可分割多于4个分区；但```dev/sda[1~4]```都是分配给主分区/拓展分区，逻辑分区就列到后面去了

- 主要分割与延伸分割最多可以有四笔(硬碟的限制)
- **延伸分割最多只能有一个**(作业系统的限制)
- 逻辑分割是由延伸分割持续切割出来的分割槽；
- 能够被格式化后，作为资料存取的分割槽为主要分割与逻辑分割。延伸分割无法格式化；
- 逻辑分割的数量依作业系统而不同，在Linux系统中SATA硬碟已经可以突破63个以上的分割限制；

如果你要分割超过4槽以上时，一定要有Extended分割槽，而且**必须将所有剩下的空间都分配给Extended**， 然后再以logical的分割来规划Extended的空间。另外，考虑到磁碟的连续性，一般**建议将Extended的磁柱号码分配在最后面的磁柱内**。

**GPT 分区表**<br>
与 MBR 仅使用第一个 512bytes 区块来纪录不同， GPT 使用了 34 个 LBA 区块来纪录分割资讯！同时与过去 MBR 仅有一的区块，被干掉就死光光的情况不同， GPT 除了前面 34 个 LBA 之外，**整个磁碟的最后 33 个 LBA 也拿来作为另一个备份**！这样或许会比较安全些吧！

> GPT的内容需要回看呢

## 开机流程中的 BIOS 与 UEFI 开机检测程式

基本上，目前的主机系统在载入硬体驱动方面的程序，主要有**早期的 BIOS** 与**新的 UEFI** 两种机制，我们分别来谈谈啰！

**BIOS 搭配 MBR/GPT 的开机流程**
1. BIOS：开机主动执行的韧体，会认识第一个可开机的装置；
> 在主板上；寻找可以开机的设备
2. MBR：第一个可开机装置的第一个扇区内的主要开机记录区块，内含**引导加载程序**；
> 在存储设备(磁盘)上，第一个扇区
3. 引导加载程序(boot loader)：一支可读取内核文件来执行的软体；
> Grub就是其中一种，可用于引导多系统
4. 核心档案：开始作业系统的功能...

由上面的说明我们会知道，BIOS与MBR都是硬体本身会支援的功能，至于**Boot loader则是作业系统安装在MBR上面的一套软体**了。由于MBR仅有446 bytes而已，因此这个开机管理程式是非常小而美的。这个boot loader的主要任务有底下这些项目：

- 提供选单：使用者可以选择不同的开机项目，这也是**多重开机**的重要功能！
- 载入核心档案：直接指向可开机的程式区段来**开始操作系统**；
- 转交其他loader：将开机管理功能**转交给其他loader**负责。

> 也是要常常回看的内容呀

**每个分割槽都拥有自己的开机磁区**(boot sector), loader只会认识自己的系统槽内的可开机核心档案，以及其他loader而已;loader可直接指向或者是间接将管理权转交给另一个管理程式。

『**如果要安装多重开机， 最好先安装Windows再安装Linux**』呢？这是因为：

- **Linux**在安装的时候，你可以选择将boot loader安装在MBR或各别分割槽的开机磁区， 而且Linux的loader可以手动设定选单(就是上图的M1, M2...) ，所以**你可以在Linux的boot loader里面加入Windows开机的选项**；

- Windows在安装的时候，他的安装程式**会主动的覆盖掉MBR以及自己所在分割槽的开机磁区**，你没有选择的机会， 而且他没有让我们自己选择选单的功能。

> 那么问题来了，装了Linux以后还想装Windows该怎么办呢，怎么防止Windows覆盖MBR?

> 我在自己尝试的时候，将Ubuntu装在U盘上，发现开机进入Grub，是不是Ubuntu自带了Grub，然后Grub覆盖了MBR？然后我将U盘内容格式化，又能直接引导进入Windows，那Grub还在不在？

**UEFI BIOS 搭配 GPT 开机的流程**

- 与传统的 BIOS 不同，UEFI 简直就像是一个**低阶的作业系统**
- 硬体资源的管理使用轮询 (polling) 的方式来管理，与 BIOS 直接了解 CPU 以中断的方式来管理比较， 这种 **polling 的效率是稍微慢一些**的

>下面这一点，我在Dell机上重装系统就遇到过；说明这台机是UEFI
- 此外，由于过去cracker 经常藉由BIOS 开机阶段来破坏系统，并取得系统的控制权，因此**UEFI 加入了一个所谓的安全启动(secure boot) 机制**， 这个机制代表着即将开机的作业系统必须要被UEFI 所验证，否则就无法顺利开机！微软用了很多这样的机制来管理硬体。不过**加入这个机制后，许多的作业系统，包括 Linux ，就很有可能无法顺利开机**喔！所以，某些时刻，你可能得要**将 UEFI 的 secure boot 功能关闭**， 才能够顺利的进入 Linux 哩！ (这一点让自由软体工作者相当感冒啦！)